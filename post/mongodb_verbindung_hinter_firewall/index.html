<!DOCTYPE html>
<html lang="de-de">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Wie erreicht man ein MongoDB-Cluster, wenn die Firewall dazwischen liegt und man das CLI für Dumps benutzen möchte."><meta name="author" content="Andreas">

    <title>MongoDB-Cluster Verbindung durch Firewall -- ChaosBlog</title>

    

    
    <link href="https://blog.networkchallenge.de//css/bootstrap.min.css" rel="stylesheet">

    
    <link href="https://blog.networkchallenge.de//css/clean-blog.min.css" rel="stylesheet">
    <link href="https://blog.networkchallenge.de//css/style.css" rel="stylesheet">
    
    <link href="https://blog.networkchallenge.de//css/font-awesome.min.css" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
    
    <link rel="icon" type="image/png" href="https://blog.networkchallenge.de//img/favicon.png">

    
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
	<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
	<script>
	window.addEventListener("load", function(){
	window.cookieconsent.initialise({
	  "palette": {
	    "popup": {
	      "background": "#000"
	    },
	    "button": {
	      "background": "#f1d600"
	    }
	  },
	  "position": "bottom-left",
	  "content": {
    "message": "Diese Website benutzt Cookies zur automatisierten Nutzerauswertung mit Google Analytics.",
    "dismiss": "Verstanden",
    "link": "Datenschutzerklärung",
    "href": "/privacypolicy/"
    }
	})});
	</script>

    
    <script>
        function loadJS(u){var r=document.getElementsByTagName("script")[0],s=document.createElement("script");s.src=u;r.parentNode.insertBefore(s,r);}

        if(!window.HTMLPictureElement || !('sizes' in document.createElement('img'))){
            loadJS("https:\/\/blog.networkchallenge.de\//js/ls.respimg.min.js");
        }
    </script>
    <script src="https://blog.networkchallenge.de//js/ls.bgset.min.js"></script>
    <script src="https://blog.networkchallenge.de//js/lazysizes.min.js" async=""></script>

    
    
    

    <link type="text/css" rel="stylesheet" href="https://blog.networkchallenge.de//css/lightgallery.min.css" />
    
  <script>
      var gaProperty = 'UA-259583-6';
      var disableStr = 'ga-disable-' + gaProperty;
      if (document.cookie.indexOf(disableStr + '=true') > -1) {
          window[disableStr] = true;
      }
  </script>
  
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-259583-6"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'UA-259583-6', { 'anonymize_ip': true });
	</script><link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script></head>

<body>

    
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://blog.networkchallenge.de/">ChaosBlog</a>
            </div>

                       
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    
                    <li>
                        <a href="/rtw">Weltreise</a>
                    </li>
                    
                    <li>
                        <a href="/about">Über</a>
                    </li>
                    
                    <li>
                        <a href="/post/">Archiv</a>
                    </li>
                    
                  </ul>
            </div>
           

        </div>
        
    </nav>


    
    
    <header class="intro-header lazyload" data-bgset="https://imgs.networkchallenge.de/800x/home-bg.jpg 800w, https://imgs.networkchallenge.de/400x/home-bg.jpg 400w, https://imgs.networkchallenge.de/1600x/home-bg.jpg 1600w, https://imgs.networkchallenge.de/2100x/home-bg.jpg 2100w, https://imgs.networkchallenge.de/3200x/home-bg.jpg 3200w" data-sizes="auto">
    
      <div class="header-bg">
      <div class="container">
        <div class="row">
           <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="page-heading">
             <div class="title">
               <h1>MongoDB-Cluster Verbindung durch Firewall</h1>
               <span class="meta">
                 
23. Sep 2018
<br />
In: <a href="/categories/tech">tech</a>

Tags: <a href="/tags/devops">devops</a>, <a href="/tags/docker">docker</a>

               </span>
               <hr class="small">
               <h2 class="subheading">Wie erreicht man ein MongoDB-Cluster, wenn die Firewall dazwischen liegt und man das CLI für Dumps benutzen möchte.</h2>
             </div>
            </div>
           </div>
        </div>
      </div>
      </div>
    </header>

    
    <article>
        <div class="container" id="post">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
		<p>Auf Arbeit stand ich vor dem Problem, auf einem <a href="https://www.mongodb.com/cloud/atlas">MongoDB Atlas</a>-Cluster einen Dump einspielen zu müssen. Dafür ist aber die Benutzung der Kommandozeilenwerkzeuge <code>mongodump</code> und <code>mongorestore</code> unabdingbar. Die Herausforderung war aber eine, die mich regelmäßig quält: das Sicherheitsbedürfnis des Unternehmens steht an oberster Stelle und wir müssen somit immer über den Unternehmens-Proxy oder dedizierte Jumphosts gehen, die für bestimmte Verbindungen freigeschaltet sind.</p>

<p>Bei der Verbindung zu einem Replica Set steht man vor der Herausforderung, dass der Client eine Verbindung zu allen Nodes machen will und bekommt dabei die Serveradressen von der Gegenseite mitgeteilt. Dies macht es nicht so einfach, die Verbindungen einzeln per SSH zu tunneln. Man muss dafür immer an den Hostnames herumfummeln (siehe dieser <a href="https://blockdev.io/connecting-to-a-mongo-replica-set-via-ssh/">Beitrag</a>). Das Problem ist jetzt wieder, dass Hostnames unter Windows als Nicht-Admin wieder schwer zu ändern sind &hellip; ein Teufelskreis.</p>

<p>Da ich immer wieder die Vorteile (Reproduzierbarkeit, Plattformunabhängigkeit, &hellip;) von Docker betone, habe ich mir meine Gedanken gemacht, um ein relativ einfaches Setup mit Docker zu realisieren, so dass ich auf dem Rechner selbst auch die MongoDB-Tools in Docker nutzen kann.</p>

<p>Das ganze Setup habe ich unter Windows (Git Bash) und MacOS getestet und erwartet einen Rechner, den ich als SSH-Jumphost nutzen kann und der somit ausgehende Verbindungen zu Port 27017, respektive den MongoDB Atlas Hosts hat. Los geht&rsquo;s:</p>

<h2 id="ssh-tunnel">SSH Tunnel</h2>

<p>Auf dem lokalen Rechner wird nun eine SSH Verbindung und insgesamt 3 Tunnel zu den einzelnen Knoten des Replica Sets aufgebaut. Die Namen der einzelnen Rechner bekommt man in der Weboberfläche von MongoDB Atlas im Menüpunkt <em>Connect</em> (Details für MongoDB 3.4 Clients). Nun machen wir in einer SSH-Verbindung insgesamt 3 Tunnel auf:</p>

<p><code>ssh -g -L 27017:your-shard-00.gcp.mongodb.net:27017 -L27018:your-shard-01.gcp.mongodb.net:27017 -L27019:your-shard-02.gcp.mongodb.net:27017 jumphost</code></p>

<p>Alle drei Verbindungen lauschen lokal auf drei verschiedenen Ports (27017-27019). Notwendig ist nun noch das Flag <code>-g</code>, um den Port &ldquo;von außen&rdquo; (dem Docker-Netzwerk) zugänglich zu machen.</p>

<h2 id="mongodb-verbinden">MongoDB verbinden</h2>

<p>Für die Verbindung gibt es nun ein <code>docker-compose</code>-File, welches das MongoDB-Image (mit den CLI Tools) zur Verfügung stellt. Weiterhin werden noch 3 Container gestartet, um auf die lokalen SSH-Tunnel weiterzuleiten. Wieso 3? Weil jeder der Container auf einer Docker-IP jeweils auf Port 27017 einen Tunnel bereitstellen muss. Docker ermöglicht es uns, dem MongoDB Container diese 3 Container-IPs den Hostnames der Ziel-DB-Knoten zuzuordnen (extra/additional hosts). Dadurch denkt der Client, er verbindet sich mit den 3 Zielhosts und auch SSL macht somit keine Probleme.</p>

<script src="//gist.github.com/adulescentulus/d4a4977abf1b76d314ee74dc78a144d4.js"></script>

<p>Speichert man die <code>docker-compose.yml</code> nun in einem Ordner <code>mdb</code>, dann kann man die Container alle starten:</p>

<p><code>docker-compose up -d</code></p>

<p>Wichtig zu wissen ist noch, dass in der <em>yml</em>-Datei der lokale Rechner (der die 3 SSH-Tunnel bereitstellt) aus den beiden Variablen zusammengebaut wird: <code>${HOSTNAME}.${USERDNSDOMAIN}</code> Unter Windows in der Git Bash sind diese gesetzt, unter MacOS und Linux muss man diese manuell setzen, so dass man seinen Rechner erreicht.</p>

<p>Im nächsten Schritt verbinden wir uns nun mit dem MongoDB-Container:</p>

<p><code>docker-compose exec mongodb bash</code></p>

<p>Nun können die Kommandozeilenwerkzeuge mit dem Connection-String benutzt werden. Daten in den und aus dem Container übertragen wir mit <code>docker cp ...</code>.</p>

                  <hr class="margin">
                  
   <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "thechaosblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


                </div>
            </div>
        </div>
    </article>

    <hr>
    
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  <ul class="list-inline text-center">
                    
                    
                    <li>
                      <a href="https://plus.google.com/&#43;AndreasGroll">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-google-plus-official fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://github.com/adulescentulus">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                  </ul>
                  <p class="copyright text-muted"><a href="/privacypolicy/index.html" title="Datenschutzerklärung">Datenschutzerklärung</a><br>Copyright © ChaosBlog 2018</p>
                </div>
            </div>
        </div>
    </footer>

    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

    
    <script src="https://blog.networkchallenge.de//js/bootstrap.min.js"></script>

    
    <script src="https://blog.networkchallenge.de//js/clean-blog.js"></script>
    <script src="https://blog.networkchallenge.de//js/lightgallery.min.js"></script>
    <script>$(document).ready(function () {
    $('#post').lightGallery({
      selector: '.gallery'
    });
});</script>
</body>

</html>

